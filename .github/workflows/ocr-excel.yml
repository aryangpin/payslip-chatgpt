name: Payslip (Claude Vision) â†’ Excel

on:
  push:
    paths:
      - "*.jpg"
      - "*.jpeg"
      - "*.png"
      - ".github/workflows/ocr-excel.yml"

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install anthropic pillow openpyxl

      - name: Process payslip with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python <<'PY'
          import os, base64, json, re
          from pathlib import Path
          from openpyxl import load_workbook

          # =============== helpers ===============
          def pick_latest_image():
              imgs = [p for p in Path(".").glob("*") if p.suffix.lower() in [".jpg",".jpeg",".png"]]
              if not imgs:
                  raise SystemExit("âŒ æ²¡æœ‰æ‰¾åˆ° payslip å›¾ç‰‡ï¼ˆ.jpg/.jpeg/.pngï¼‰")
              imgs.sort(key=lambda p: p.stat().st_mtime)
              return imgs[-1]

          def to_b64(path: Path):
              return base64.b64encode(path.read_bytes()).decode("utf-8")

          def media_type(path: Path):
              return "image/png" if path.suffix.lower()==".png" else "image/jpeg"

          def to_num(x):
              if x is None: return None
              if isinstance(x,(int,float)): return float(x)
              s = str(x).strip().replace(",","")
              s = re.sub(r"[^\d.\-]","",s)
              try: return float(s)
              except: return None

          # =============== config ===============
          img = pick_latest_image()
          img_b64 = to_b64(img)
          mtype = media_type(img)

          # å…è®¸ç”¨æˆ·åœ¨ repo æ”¾ä¸€ä¸ª prompt.txt è¿½åŠ è§„åˆ™ï¼ˆå¯é€‰ï¼‰
          prompt_extra = Path("prompt.txt").read_text(encoding="utf-8", errors="ignore") if Path("prompt.txt").exists() else ""

          SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªå·¥èµ„å•(payslip)ç»“æž„åŒ–åŠ©æ‰‹ã€‚åªä»Žå›¾ç‰‡ä¸­æå–æŒ‡å®šå­—æ®µï¼Œè¿”å›žä¸¥æ ¼ JSONï¼Œä¸è¦å¤šä½™æ–‡æœ¬ã€‚
          è¯†åˆ«å­—æ®µï¼ˆè‹¥æ— åˆ™å¡« 0 æˆ– nullï¼‰ï¼š
          - staff_code  (åŒ EMPLOYEE / LINE NO.)
          - basic_pay
          - ot_hours      (1.5x å°æ—¶, è‹¥åªçœ‹åˆ°é‡‘é¢ä¹Ÿå¯ç•™ç©º)
          - ot_amount     (1.5x é‡‘é¢)
          - ot_total      (åŠ ç­åˆè®¡)
          - incentive     (å¥–é‡‘)
          - allowance     (å„ç±»æ´¥è´´æ€»å’Œ)
          - total_payable (æœˆæ€»æ”¶å…¥)
          - epf_employer, epf_employee
          - socso_employer, socso_employee
          - eis_employer, eis_employee
          - nett_pay
          æ³¨æ„ï¼š
          1) staff_code åŽŸæ ·è¿”å›žï¼Œä¾‹å¦‚ AA02 / AF0001 / 20004 ç­‰ï¼›ä¸è¦é™„åŠ æ–‡å­—ã€‚
          2) é‡‘é¢ä¸Žå°æ—¶è¿”å›žæ•°å­—ï¼›æ²¡çœ‹åˆ°å°±ç”¨ nullã€‚
          3) åªè¾“å‡º JSONã€‚"""

          USER_PROMPT = f"""è¯·ä»Žä¸‹é¢å·¥èµ„å•å›¾ç‰‡ä¸­æå–å­—æ®µï¼Œä¸¥æ ¼è¾“å‡º JSONã€‚
          é¢å¤–è§„åˆ™ï¼ˆå¯é€‰ï¼‰ï¼š{prompt_extra}
          """

          # =============== call Claude (fallback chain) ===============
          from anthropic import Anthropic
          client = Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

          candidates = [
              "claude-3-5-sonnet-latest",
              "claude-3-5-haiku-latest",
              "claude-3-haiku-20240307",
          ]
          last_err = None
          resp_text = None

          for model in candidates:
              try:
                  resp = client.messages.create(
                      model=model,
                      max_tokens=1500,
                      temperature=0,
                      system=SYSTEM_PROMPT,
                      messages=[{
                        "role":"user",
                        "content":[
                          {"type":"image","source":{"type":"base64","media_type": mtype,"data": img_b64}},
                          {"type":"text","text": USER_PROMPT}
                        ]
                      }]
                  )
                  # Claude å¯èƒ½è¿”å›žå¤šå—ï¼Œæ‹¼èµ·æ¥
                  txt = "".join(getattr(b,"text","") for b in resp.content if getattr(b,"type",None)=="text")
                  if not txt:
                      raise RuntimeError("Claude æ²¡è¿”å›žæ–‡æœ¬")
                  resp_text = txt
                  print(f"âœ… Using model: {model}")
                  break
              except Exception as e:
                  print(f"âš ï¸ æ¨¡åž‹ {model} è°ƒç”¨å¤±è´¥ï¼š{e}")
                  last_err = e
          if resp_text is None:
              raise SystemExit(f"âŒ æ‰€æœ‰å€™é€‰æ¨¡åž‹éƒ½å¤±è´¥ï¼š{last_err}")

          # =============== parse JSON ===============
          s = resp_text.strip()
          if not (s.startswith("{") and s.endswith("}")):
              m = re.search(r"\{[\s\S]+\}", s)
              s = m.group(0) if m else None
          if not s:
              print("ðŸŸ  Claude åŽŸå§‹è¾“å‡º(å‰400)ï¼š", resp_text[:400])
              raise SystemExit("âŒ æœªæˆªå–åˆ° JSON")

          try:
              data = json.loads(s)
          except Exception as e:
              print("ðŸŸ  JSON è§£æžå¤±è´¥ï¼š", e)
              print(s[:800])
              raise SystemExit("âŒ JSON ä¸åˆæ³•")

          # =============== open Excel ===============
          tpl = Path("SA - Empty.xlsx")
          if not tpl.exists():
              raise SystemExit("âŒ æ‰¾ä¸åˆ°æ¨¡æ¿ï¼šSA - Empty.xlsx")
          wb = load_workbook(tpl)
          ws = wb.active

          # Staff Code æ ‡å‡†åŒ–ï¼ˆå­—ç¬¦ä¸²ã€åŽ»ç©ºæ ¼ã€å¤§å†™ï¼‰
          detected = str(data.get("staff_code","")).strip().upper()
          if not detected:
              raise SystemExit("âŒ æœªè¯†åˆ«åˆ° staff_code")

          # åœ¨ A åˆ—æŸ¥æ‰¾å¯¹åº”è¡Œ
          row = None
          for r in range(2, ws.max_row+1):
              val = ws[f"A{r}"].value
              if val is not None and str(val).strip().upper()==detected:
                  row = r
                  break
          if not row:
              # æ‰“å°å‰å‡ è¡Œæ ·ä¾‹å¸®åŠ©æŽ’é”™
              sample = [str(ws[f"A{i}"].value) for i in range(2, min(ws.max_row, 20)+1)]
              raise SystemExit(f"âŒ æ¨¡æ¿ Aåˆ— æ‰¾ä¸åˆ° staff_code={detected}ï¼›æ ·ä¾‹ï¼š{sample[:10]}")

          # =============== å†™å…¥å„åˆ—ï¼ˆæŒ‰ä½ éœ€æ±‚ï¼‰ ===============
          # E: Basic Pay
          bp = to_num(data.get("basic_pay"));          ws[f"E{row}"] = bp if bp is not None else None

          # H/I/R: OT
          oh = to_num(data.get("ot_hours"));           ws[f"H{row}"] = oh if oh is not None else None
          oa = to_num(data.get("ot_amount"));          ws[f"I{row}"] = oa if oa is not None else None
          ot_total = to_num(data.get("ot_total"));     ws[f"R{row}"] = ot_total if ot_total is not None else None

          # T: Incentive
          inc = to_num(data.get("incentive"));         ws[f"T{row}"] = inc if inc is not None else None

          # W: Allowance(åˆè®¡)
          alw = to_num(data.get("allowance"));         ws[f"W{row}"] = alw if alw is not None else None

          # X: Total Payable
          tp = to_num(data.get("total_payable"));      ws[f"X{row}"] = tp if tp is not None else None

          # Y/Z/AA: EPF
          epf_er = to_num(data.get("epf_employer"));   ws[f"Y{row}"] = epf_er if epf_er is not None else None
          epf_ee = to_num(data.get("epf_employee"));   ws[f"Z{row}"] = epf_ee if epf_ee is not None else None
          ws[f"AA{row}"] = (epf_er or 0) + (epf_ee or 0) if (epf_er is not None or epf_ee is not None) else None

          # AB/AC/AD: SOCSO
          socso_er = to_num(data.get("socso_employer")); ws[f"AB{row}"] = socso_er if socso_er is not None else None
          socso_ee = to_num(data.get("socso_employee")); ws[f"AC{row}"] = socso_ee if socso_ee is not None else None
          ws[f"AD{row}"] = (socso_er or 0) + (socso_ee or 0) if (socso_er is not None or socso_ee is not None) else None

          # AE/AF/AG: EIS
          eis_er = to_num(data.get("eis_employer"));   ws[f"AE{row}"] = eis_er if eis_er is not None else None
          eis_ee = to_num(data.get("eis_employee"));   ws[f"AF{row}"] = eis_ee if eis_ee is not None else None
          ws[f"AG{row}"] = (eis_er or 0) + (eis_ee or 0) if (eis_er is not None or eis_ee is not None) else None

          # AK: Nett Pay
          nett = to_num(data.get("nett_pay"));         ws[f"AK{row}"] = nett if nett is not None else None

          out = Path("SA - Updated.xlsx")
          wb.save(out)
          print(f"âœ… å·²å†™å…¥ {out}ï¼›åŒ¹é… staff_code={detected}ï¼Œè¡Œ={row}ï¼›å›¾ç‰‡={img.name}")
          PY

      - name: Commit result
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "SA - Updated.xlsx" || true
          git commit -m "Update SA - Updated.xlsx (auto from payslip)" || echo "nothing to commit"
          git push
