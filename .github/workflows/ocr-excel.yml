name: Payslip Automation OCR to Excel

on:
  push:
    paths:
      - '**.jpg'
      - '**.jpeg'
      - '**.png'

jobs:
  ocr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install openpyxl pillow pytesseract

    - name: Install Tesseract
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr

    - name: Process Payslip
      run: |
        python <<'EOF'
        import os, re, glob
        from pathlib import Path
        from PIL import Image
        import pytesseract
        from openpyxl import load_workbook

        # ========== å·¥å…·å‡½æ•° ==========
        def find_first_image():
          imgs = sorted([p for p in os.listdir('.') if p.lower().endswith(('.jpg','.jpeg','.png'))])
          if not imgs:
            raise SystemExit("âŒ æ²¡æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶")
          return imgs[-1]  # å–æœ€æ–°ä¸€å¼ ï¼ˆæŒ‰åå­—æŽ’åºçš„æœ€åŽä¸€ä¸ªï¼‰

        def num(s):
          if s is None: return None
          s = s.replace(',', '').strip()
          try:
            return float(s)
          except:
            return None

        def find(patterns, text, flags=re.IGNORECASE):
          if isinstance(patterns, str):
            patterns = [patterns]
          for pat in patterns:
            m = re.search(pat, text, flags)
            if m:
              return m.group(1)
          return None

        # ========== è¯»å– prompt.txtï¼ˆå¯é€‰ï¼‰ ==========
        rules = ""
        if Path("prompt.txt").exists():
          rules = Path("prompt.txt").read_text(encoding="utf-8", errors="ignore")
          print("âœ… è¯»å– prompt.txt æˆåŠŸ")
        else:
          print("âš ï¸ æ²¡æœ‰ prompt.txtï¼Œä½¿ç”¨å†…ç½®é»˜è®¤è§„åˆ™")

        # ========== OCR ==========
        img_file = find_first_image()
        print(f"ðŸŽ¯ OCR ç›®æ ‡: {img_file}")
        text = pytesseract.image_to_string(Image.open(img_file), lang='eng')
        print("ðŸ“„ OCR æ–‡æœ¬ï¼ˆå‰400å­—ï¼‰ï¼š\n" + text[:400])

        # ========== æå– Staff Code ==========
        staff_code_patterns = [
          r"(?:EMPLOYEE\s*/\s*LINE\s*NO\.|LINE\s*NO\.|STAFF\s*CODE)\s*[:\-]?\s*([A-Z]{1,3}\d{1,6}|\d{3,6})",
          r"\b([A-Z]{1,3}\d{2,6})\b",   # AA02 / AF0001
          r"\b(\d{4,6})\b"              # 20004
        ]
        staff_code = find(staff_code_patterns, text)
        staff_code = staff_code.upper() if staff_code else "UNKNOWN"
        print(f"âœ… Staff Code è¯†åˆ«ï¼š{staff_code}")

        # ========== å…³é”®é‡‘é¢å­—æ®µï¼ˆå¯æŒ‰éœ€è¦ç»§ç»­æ‰©å±•ï¼‰==========
        # Basic Pay
        basic_patterns = [
          r"BASIC\s*PAY\s*[:\-]?\s*([0-9,]+\.\d{1,2}|[0-9,]+)",
          r"BASIC\s*RATE\s*[:\-]?\s*([0-9,]+\.\d{1,2}|[0-9,]+)"
        ]
        basic_pay = num(find(basic_patterns, text))

        # OTï¼ˆHRS/DAY & Amountï¼‰
        ot_hours = num(find([r"HRS\s*/\s*DAY\s*[:\-]?\s*([0-9,]+\.\d+|[0-9,]+)",
                             r"OT\s*HOURS\s*[:\-]?\s*([0-9,]+\.\d+|[0-9,]+)"], text))
        ot_amount = num(find([r"AMOUNT\s*[:\-]?\s*([0-9,]+\.\d{1,2}|[0-9,]+)",
                              r"OT\s*AMT\s*[:\-]?\s*([0-9,]+\.\d{1,2}|[0-9,]+)"], text))

        # Nett Pay
        nett_pay = num(find([r"NETT?\s*PAY\s*[:\-]?\s*([0-9,]+\.\d{1,2}|[0-9,]+)"], text))

        print(f"ðŸ§¾ åŸºæœ¬å·¥èµ„ Basic Pay: {basic_pay}")
        print(f"â±ï¸ OT Hours: {ot_hours}")
        print(f"ðŸ’µ OT Amount: {ot_amount}")
        print(f"âœ… Nett Pay: {nett_pay}")

        # ========== æ‰“å¼€ Excel æ¨¡æ¿ ==========
        template = "SA - Empty.xlsx"
        if not Path(template).exists():
          raise SystemExit("âŒ æ‰¾ä¸åˆ° Excel æ¨¡æ¿ï¼šSA - Empty.xlsx")
        wb = load_workbook(template)
        ws = wb.active

        # ========== åœ¨Aåˆ—å¯»æ‰¾ Staff Code ==========
        if staff_code == "UNKNOWN":
          raise SystemExit("âŒ Staff Code è¯†åˆ«å¤±è´¥ï¼ˆUNKNOWNï¼‰ï¼Œè¯·æ£€æŸ¥ç¥¨æ®æ–‡å­—æˆ–æ­£åˆ™è§„åˆ™ï¼‰")

        target_row = None
        for r in range(2, ws.max_row + 1):
          val = ws[f"A{r}"].value
          if val and str(val).strip().upper() == staff_code:
            target_row = r
            break
        if not target_row:
          raise SystemExit(f"âŒ Staff Code {staff_code} ä¸å­˜åœ¨äºŽæ¨¡æ¿ï¼ˆAåˆ—ï¼‰")

        # ========== å†™å…¥å¯¹åº”åˆ— ==========
        # ä½ ä¹‹å‰æŒ‡å®šï¼šE=Basic Pay, H=OT Hours, I=OT Amount, AK=Nett Pay
        if basic_pay is not None: ws[f"E{target_row}"] = basic_pay
        if ot_hours is not None:  ws[f"H{target_row}"] = ot_hours
        if ot_amount is not None: ws[f"I{target_row}"] = ot_amount
        if nett_pay is not None:  ws[f"AK{target_row}"] = nett_pay

        out_file = "SA - Updated.xlsx"
        wb.save(out_file)
        print(f"âœ… å·²å†™å…¥å¹¶ä¿å­˜ï¼š{out_file}")
        EOF

    - name: Commit Excel
      run: |
        git config --global user.name "chatgpt-bot"
        git config --global user.email "bot@example.com"
        git add "SA - Updated.xlsx" || true
        git commit -m "Auto generated Excel from payslip" || echo "No changes"
        git push
