name: Payslip (Claude Vision) â†’ Excel

on:
  push:
    paths:
      - '**.jpg'
      - '**.jpeg'
      - '**.png'
      - 'staff_map.csv'
      - 'prompt.txt'
      - '.github/workflows/payslip-claude.yml'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install anthropic pillow openpyxl

      - name: Process payslip with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python <<'PY'
          import os, base64, json, re, csv
          from pathlib import Path
          from PIL import Image
          from openpyxl import load_workbook

          # ---------- helpers ----------
          def pick_image():
              imgs = [p for p in os.listdir('.') if p.lower().endswith(('.jpg','.jpeg','.png'))]
              if not imgs: raise SystemExit("âŒ æ²¡æœ‰æ‰¾åˆ° payslip å›¾ç‰‡ï¼ˆ.jpg/.pngï¼‰")
              imgs.sort()
              return imgs[-1]

          def to_b64(path):
              with open(path,'rb') as f: return base64.b64encode(f.read()).decode('utf-8')

          def mime(path):
              ext = Path(path).suffix.lower()
              return 'image/png' if ext=='.png' else 'image/jpeg'

          def to_num(x):
              if x is None: return None
              if isinstance(x,(int,float)): return float(x)
              x = str(x).replace(',','').strip()
              try: return float(x)
              except: return None

          # ---------- optional prompt ----------
          prompt_rules = ""
          if Path("prompt.txt").exists():
              prompt_rules = Path("prompt.txt").read_text(encoding='utf-8', errors='ignore')

          img = pick_image()
          print(f"ðŸŽ¯ Image: {img}")

          # ---------- call Claude Vision ----------
          from anthropic import Anthropic
          client = Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

          schema = {
              "type":"object",
              "properties":{
                  "staff_code":{"type":"string", "description":"EMPLOYEE / LINE NO. æˆ– STAFF CODEï¼ˆå¦‚ AA02/AF0001/20004ï¼‰"},
                  "basic_pay":{"type":"number"},
                  "ot_hours":{"type":"number"},
                  "ot_amount":{"type":"number"},
                  "ot_total":{"type":"number"},
                  "incentive":{"type":"number"},
                  "allowances":{"type":"array","items":{"type":"number"}, "description":"æœ€å¤š5ä¸ªï¼ŒæŒ‰ S..W åˆ—ä½"},
                  "total_payable":{"type":"number"},
                  "epf_employer":{"type":"number"},
                  "epf_employee":{"type":"number"},
                  "socso_employer":{"type":"number"},
                  "socso_employee":{"type":"number"},
                  "eis_employer":{"type":"number"},
                  "eis_employee":{"type":"number"},
                  "nett_pay":{"type":"number"}
              },
              "required":["staff_code"]
          }

          sys_prompt = (
            "ä½ æ˜¯å·¥èµ„å•æŠ½å–åŠ©æ‰‹ã€‚"
            "ä»Žå›¾ç‰‡å‡†ç¡®æå–å­—æ®µå¹¶ä¸¥æ ¼è¾“å‡º JSONï¼›å°æ•°ä¿ç•™åŽŸç²¾åº¦ï¼›æ²¡æ‰¾åˆ°çš„å­—æ®µä¸è¦ç¼–é€ ï¼Œçœç•¥å³å¯ã€‚"
            "ä¸è¦ä¿®æ”¹å§“åå’ŒNRICã€‚"
            + ("\nè§„åˆ™/å¤‡æ³¨ï¼š\n"+prompt_rules if prompt_rules else "")
          )

          user_text = (
            "è¯·ä»Žè¿™å¼  payslip æå–å­—æ®µï¼Œä¸¥æ ¼ç¬¦åˆç»™å®š JSON æž¶æž„ï¼š"
            "staff_code, basic_pay, ot_hours, ot_amount, ot_total, incentive, allowances(è‡³å¤š5), "
            "total_payable, epf_employer, epf_employee, socso_employer, socso_employee, "
            "eis_employer, eis_employee, nett_payã€‚"
            "æ³¨æ„ï¼šstaff_code å³ EMPLOYEE/LINE NO. æˆ– STAFF CODEã€‚"
          )

          img_b64 = to_b64(img)
          media_type = mime(img)

          # Claude 3.5 Sonnetï¼ˆ2024-06 ä¹‹åŽçš„ç¨³å®šç‰ˆæœ¬åï¼Œè‹¥ä½ æœ‰æ›´æ–°çš„å¯æ›¿æ¢ï¼‰
          model_name = "claude-3-5-sonnet-20240620"

          resp = client.messages.create(
              model=model_name,
              max_tokens=1200,
              temperature=0,
              system=sys_prompt,
              messages=[{
                  "role":"user",
                  "content":[
                      {"type":"image", "source":{"type":"base64", "media_type": media_type, "data": img_b64}},
                      {"type":"text", "text": user_text}
                  ]
              }]
          )

          # å–æ–‡æœ¬
          txt = ""
          for block in resp.content:
              if block.type == "text":
                  txt += block.text
          if not txt:
              raise SystemExit("âŒ Claude æ²¡è¿”å›žæ–‡æœ¬å†…å®¹")

          # å°è¯•æå– JSONï¼ˆå®¹é”™ï¼‰
          def extract_json(s):
              s = s.strip()
              # ç›´æŽ¥å°±æ˜¯ JSON
              if s.startswith("{") and s.endswith("}"):
                  return s
              # ä»Žæ–‡æœ¬ä¸­æå–é¦–ä¸ª {...}
              m = re.search(r"\{.*\}", s, flags=re.S)
              return m.group(0) if m else None

          raw_json = extract_json(txt)
          if not raw_json:
              print("âš ï¸ Claude è¿”å›žï¼š\n", txt[:400])
              raise SystemExit("âŒ æœªæ‰¾åˆ°JSONå“åº”")

          try:
              data = json.loads(raw_json)
          except Exception as e:
              print("âš ï¸ JSON è§£æžå¤±è´¥ï¼š", e)
              print(raw_json[:500])
              raise SystemExit("âŒ JSON ä¸åˆæ³•")

          # ---------- staff map ----------
          detected = str(data.get("staff_code","")).strip().upper()
          if not detected:
              raise SystemExit("âŒ æœªè¯†åˆ«åˆ° staff_code")

          mapped = detected
          mp = {}
          if Path("staff_map.csv").exists():
              with open("staff_map.csv", newline='', encoding='utf-8') as f:
                  for row in csv.DictReader(f):
                      src = (row.get("payslip_code") or "").strip().upper()
                      dst = (row.get("template_code") or "").strip().upper()
                      if src and dst: mp[src] = dst
              if detected in mp:
                  mapped = mp[detected]
                  print(f"ðŸ” staff_code æ˜ å°„: {detected} â†’ {mapped}")

          # ---------- open Excel ----------
          tpl = "SA - Empty.xlsx"
          if not Path(tpl).exists():
              raise SystemExit("âŒ æ‰¾ä¸åˆ°æ¨¡æ¿ï¼šSA - Empty.xlsx")
          wb = load_workbook(tpl)
          ws = wb.active

          # å®šä½è¡Œï¼ˆAåˆ—ï¼‰
          row = None
          for r in range(2, ws.max_row+1):
              val = ws[f"A{r}"].value
              if val and str(val).strip().upper() == mapped:
                  row = r; break
          if not row:
              # æ‰“å°å‡ ä¸ªæ ·ä¾‹å¸®åŠ©æ ¡å¯¹
              sample = [str(ws[f'A{i}'].value) for i in range(2, min(ws.max_row, 20)+1)]
              raise SystemExit(f"âŒ æ¨¡æ¿ä¸­æ‰¾ä¸åˆ° {mapped}ï¼›Aåˆ—æ ·ä¾‹ï¼š{sample[:10]}")

          # ---------- å†™å…¥åˆ—ä½ï¼ˆæŒ‰ä½ è¦æ±‚ï¼‰ ----------
          # E: Basic Pay
          bp = to_num(data.get("basic_pay"))
          if bp is not None: ws[f"E{row}"] = bp

          # H/I/R: OT
          oh = to_num(data.get("ot_hours"))
          if oh is not None: ws[f"H{row}"] = oh
          oa = to_num(data.get("ot_amount"))
          if oa is not None: ws[f"I{row}"] = oa
          ot_total = to_num(data.get("ot_total"))
          if ot_total is not None: ws[f"R{row}"] = ot_total

          # T: Incentive
          inc = to_num(data.get("incentive"))
          if inc is not None: ws[f"T{row}"] = inc

          # S..W: Allowances æ•°ç»„æœ€å¤š5é¡¹ï¼›W ä¹Ÿå¸¸ä½œä¸º allowance åˆè®¡ä½ï¼ˆå¦‚éœ€ï¼‰
          allowances = data.get("allowances") or []
          cols_SW = ["S","T","U","V","W"]  # æ³¨æ„ï¼šT å·²ç”¨äºŽ incentiveï¼›å¦‚å†²çªä½ å¯æ”¹ä¸º S,U,V,W,? è‡ªè¡Œè°ƒæ•´
          # ä¸ºé¿å…è¦†ç›– T çš„ incentiveï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠ Allowances å†™å…¥ U..Wï¼Œå¹¶æŠŠæ€»é¢å†™ Wï¼ˆè‹¥ä½ å¸Œæœ›å¦‚æ­¤ï¼‰
          # æ–¹æ¡ˆï¼šU..W æ”¾ allowances[0..3]ï¼ŒW åŒæ—¶å¯è¢«è§†ä¸ºæ€»é¢ï¼ˆå¦‚éœ€æ€»é¢ï¼Œç”¨ sum è¦†ç›– Wï¼‰
          # ç®€åŒ–ï¼šåªæŠŠ allowances æ€»é¢å†™ Wï¼Œé¿å…å†²çªï¼š
          if isinstance(allowances, list) and allowances:
              allow_sum = sum(to_num(x) or 0.0 for x in allowances[:5])
              ws[f"W{row}"] = allow_sum

          # X: Total Payable
          tp = to_num(data.get("total_payable"))
          if tp is not None: ws[f"X{row}"] = tp

          # EPF: Y/Z/AA
          epf_er = to_num(data.get("epf_employer"))
          epf_ee = to_num(data.get("epf_employee"))
          if epf_er is not None: ws[f"Y{row}"] = epf_er
          if epf_ee is not None: ws[f"Z{row}"] = epf_ee
          if (epf_er is not None) or (epf_ee is not None):
              if (epf_er is not None) and (epf_ee is not None):
                  ws[f"AA{row}"] = epf_er + epf_ee

          # SOCSO: AB/AC/AD
          socso_er = to_num(data.get("socso_employer"))
          socso_ee = to_num(data.get("socso_employee"))
          if socso_er is not None: ws[f"AB{row}"] = socso_er
          if socso_ee is not None: ws[f"AC{row}"] = socso_ee
          if (socso_er is not None) and (socso_ee is not None):
              ws[f"AD{row}"] = socso_er + socso_ee

          # EIS: AE/AF/AG
          eis_er = to_num(data.get("eis_employer"))
          eis_ee = to_num(data.get("eis_employee"))
          if eis_er is not None: ws[f"AE{row}"] = eis_er
          if eis_ee is not None: ws[f"AF{row}"] = eis_ee
          if (eis_er is not None) and (eis_ee is not None):
              ws[f"AG{row}"] = eis_er + eis_ee

          # AK: Nett Pay
          np = to_num(data.get("nett_pay"))
          if np is not None: ws[f"AK{row}"] = np

          out = "SA - Updated.xlsx"
          wb.save(out)
          print(f"âœ… å·²ä¿å­˜ï¼š{out}ï¼ˆè¡Œ {row} / Staff Code: {mapped}ï¼ŒåŽŸè¯†åˆ«ï¼š{detected}ï¼‰")
          PY

      - name: Commit result
        run: |
          git config --global user.name "chatgpt-bot"
          git config --global user.email "bot@example.com"
          git add "SA - Updated.xlsx" || true
          git commit -m "Claude Vision â†’ Excel (auto)" || echo "No changes"
          git push
